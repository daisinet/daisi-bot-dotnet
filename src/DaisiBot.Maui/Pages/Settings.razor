@page "/settings"
@inject ISettingsService SettingsService

<MudText Typo="Typo.h5" Class="mb-4">Settings</MudText>

<MudTabs Elevation="0" Rounded="true" PanelClass="pa-3">
    <MudTabPanel Text="Inference">
        <MudNumericField @bind-Value="_settings.Temperature" Label="Temperature" Min="0" Max="2" Step="0.1f" Class="mb-3" />
        <MudNumericField @bind-Value="_settings.TopP" Label="Top P" Min="0" Max="1" Step="0.05f" Class="mb-3" />
        <MudNumericField @bind-Value="_settings.MaxTokens" Label="Max Tokens" Min="256" Max="128000" Step="1024" Class="mb-3" />
        <ModelPicker />
        <ThinkLevelSelector @bind-Value="_settings.DefaultThinkLevel" />
    </MudTabPanel>

    <MudTabPanel Text="Connection">
        <MudTextField @bind-Value="_settings.OrcDomain" Label="Orc Domain" Class="mb-3" />
        <MudNumericField @bind-Value="_settings.OrcPort" Label="Orc Port" Class="mb-3" />
        <MudSwitch @bind-Value="_settings.OrcUseSsl" Label="Use SSL" Color="Color.Primary" />
        <MudTextField @bind-Value="_settings.NetworkName" Label="Network" Class="mb-3" />
    </MudTabPanel>

    <MudTabPanel Text="System Prompt">
        <MudTextField @bind-Value="_settings.SystemPrompt" Label="System Prompt" Lines="8"
                      Variant="Variant.Outlined" FullWidth="true" />
    </MudTabPanel>

    <MudTabPanel Text="Tools">
        <ToolGroupSelector @bind-EnabledGroups="_enabledGroups" />
    </MudTabPanel>

    <MudTabPanel Text="Host">
        <MudSwitch @bind-Value="_settings.HostModeEnabled" Label="Enable Self-Hosted Mode" Color="Color.Primary" Class="mb-3" />
        <MudAlert Severity="Severity.Info" Class="mb-3">
            When self-hosted mode is enabled and your bots are idle, your system will process requests for others on the network.
        </MudAlert>
        <MudTextField @bind-Value="_settings.ModelFolderPath" Label="Model Folder Path" Class="mb-3" />
        <MudNumericField T="uint" @bind-Value="_settings.ContextSize" Label="Context Size" Min="512" Max="32768" Class="mb-3" />
        <MudNumericField T="int" @bind-Value="_settings.GpuLayerCount" Label="GPU Layers (-1 = all)" Min="-1" Max="100" Class="mb-3" />
        <MudNumericField T="uint" @bind-Value="_settings.BatchSize" Label="Batch Size" Min="64" Max="4096" Class="mb-3" />
    </MudTabPanel>
</MudTabs>

<div class="d-flex justify-end mt-4">
    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save">Save</MudButton>
</div>

@if (_saved)
{
    <MudAlert Severity="Severity.Success" Class="mt-3">Settings saved.</MudAlert>
}

@code {
    private UserSettings _settings = new();
    private List<ToolGroupSelection> _enabledGroups = [];
    private bool _saved;

    protected override async Task OnInitializedAsync()
    {
        _settings = await SettingsService.GetSettingsAsync();
        _enabledGroups = _settings.GetEnabledToolGroups();
    }

    private async Task Save()
    {
        _settings.SetEnabledToolGroups(_enabledGroups);
        await SettingsService.SaveSettingsAsync(_settings);
        _saved = true;
        StateHasChanged();
        await Task.Delay(2000);
        _saved = false;
        StateHasChanged();
    }
}
