@using Markdig

<div class="d-flex mb-3 @(IsUser ? "justify-end" : "justify-start")">
    <MudPaper Class="@PaperClass" Elevation="1" Style="max-width: 80%;">
        <div class="d-flex align-center mb-1">
            <MudIcon Icon="@RoleIcon" Size="Size.Small" Class="mr-1" />
            <MudText Typo="Typo.caption" Color="Color.Default">
                @RoleLabel
            </MudText>
            <MudSpacer />
            <MudText Typo="Typo.caption" Class="mud-text-secondary">
                @Message.Timestamp.ToLocalTime().ToString("HH:mm")
            </MudText>
        </div>

        @if (Message.Type == ChatMessageType.Thinking)
        {
            <MudExpansionPanels Elevation="0" Class="mt-1" Style="background: transparent;">
                <MudExpansionPanel Style="background: transparent; color: inherit;">
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Psychology" Size="Size.Small" Class="mr-1" Style="opacity: 0.7;" />
                            <MudText Typo="Typo.caption" Style="opacity: 0.7; font-style: italic;">Chain of thought</MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Style="font-style: italic; opacity: 0.7;">
                            @Message.Content
                        </MudText>
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
        else if (Message.Type is ChatMessageType.Tooling or ChatMessageType.ToolContent)
        {
            <div class="d-flex align-center gap-2 tooling-banner">
                <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Small" Color="Color.Info" />
                <MudText Typo="Typo.caption" Color="Color.Info" Style="font-weight: 600;">
                    @(Message.Type == ChatMessageType.Tooling ? "Tool call" : "Tool result")
                </MudText>
            </div>
            <div class="tooling-content">
                <MarkdownRenderer Content="@Message.Content" />
            </div>
        }
        else
        {
            <MarkdownRenderer Content="@Message.Content" />
        }

        @if (Message.Role == ChatRole.Assistant && Message.TokenCount > 0)
        {
            <MudText Typo="Typo.caption" Class="mud-text-secondary mt-1">
                @Message.TokenCount tok | @Message.TokensPerSecond.ToString("F1") t/s | @Message.ComputeTimeMs.ToString("F0")ms
            </MudText>
        }
    </MudPaper>
</div>

@code {
    [Parameter, EditorRequired] public ChatMessage Message { get; set; } = default!;

    private bool IsUser => Message.Role == ChatRole.User;

    private bool IsTooling => Message.Type is ChatMessageType.Tooling or ChatMessageType.ToolContent;

    private string PaperClass => IsUser
        ? "pa-3 mud-theme-primary"
        : Message.Type == ChatMessageType.Thinking
            ? "pa-3 mud-theme-dark"
            : IsTooling
                ? "pa-3 tooling-bubble"
                : "pa-3";

    private string RoleIcon => IsTooling
        ? Icons.Material.Filled.Build
        : Message.Role switch
        {
            ChatRole.User => Icons.Material.Filled.Person,
            ChatRole.Assistant => Icons.Material.Filled.SmartToy,
            ChatRole.Tool => Icons.Material.Filled.Build,
            _ => Icons.Material.Filled.Info
        };

    private string RoleLabel => IsTooling
        ? "Tool"
        : Message.Role switch
        {
            ChatRole.User => "You",
            ChatRole.Assistant => "Bot",
            ChatRole.Tool => "Tool",
            _ => Message.Role.ToString()
        };
}
