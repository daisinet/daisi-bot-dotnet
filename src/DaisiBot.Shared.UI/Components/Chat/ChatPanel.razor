@using System.Text.Json
@inject IChatService ChatService
@inject IConversationStore ConversationStore
@inject ISettingsService SettingsService
@implements IDisposable

<div class="chat-panel d-flex flex-column" style="flex: 1; min-height: 0;">
    <div class="chat-messages flex-grow-1 overflow-auto pa-3" @ref="_messageContainer">
        @if (_conversation is not null)
        {
            @foreach (var msg in _conversation.Messages)
            {
                <ChatMessageBubble Message="msg" />
            }
        }

        @if (_isStreaming)
        {
            @if (_currentPlanGoal is not null)
            {
                <ActionPlanDisplay Goal="@_currentPlanGoal" Steps="_currentPlanSteps" />
            }

            <StreamingMessage Content="@_streamContent" Type="@_streamType" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-3" ShowCloseIcon="true" CloseIconClicked="() => _errorMessage = string.Empty">
                @_errorMessage
            </MudAlert>
        }
    </div>

    <ChatStatsBar Stats="_stats" />

    <ChatInput OnSend="OnSendMessage" OnStop="OnStopGeneration" IsStreaming="_isStreaming" />
</div>

@code {
    [Parameter] public Guid? ConversationId { get; set; }

    private Conversation? _conversation;
    private string _streamContent = string.Empty;
    private string _streamType = "Text";
    private string _errorMessage = string.Empty;
    private bool _isStreaming;
    private ChatStats _stats = new();
    private ElementReference _messageContainer;
    private CancellationTokenSource? _cts;

    // Agent plan state
    private string? _currentPlanGoal;
    private List<ActionPlanDisplay.ActionPlanStep> _currentPlanSteps = [];

    private Guid? _previousConversationId;

    protected override async Task OnParametersSetAsync()
    {
        if (ConversationId.HasValue && ConversationId != _previousConversationId)
        {
            if (_previousConversationId.HasValue)
                await ChatService.CloseSessionAsync();

            _previousConversationId = ConversationId;
            _conversation = await ConversationStore.GetAsync(ConversationId.Value);
            StateHasChanged();
        }
    }

    [Parameter] public EventCallback<Guid> OnConversationCreated { get; set; }

    private async Task OnSendMessage(string message)
    {
        if (string.IsNullOrWhiteSpace(message)) return;

        if (_conversation is null)
        {
            _conversation = new Conversation { Title = message.Length > 50 ? message[..50] + "..." : message };
            _conversation = await ConversationStore.CreateAsync(_conversation);
            await OnConversationCreated.InvokeAsync(_conversation.Id);
        }

        _isStreaming = true;
        _streamContent = string.Empty;
        _errorMessage = string.Empty;
        _currentPlanGoal = null;
        _currentPlanSteps = [];
        _cts = new CancellationTokenSource();

        var settings = await SettingsService.GetSettingsAsync();
        var config = new AgentConfig
        {
            ModelName = !string.IsNullOrWhiteSpace(_conversation.ModelName) ? _conversation.ModelName : settings.DefaultModelName,
            InitializationPrompt = _conversation.SystemPrompt,
            ThinkLevel = _conversation.ThinkLevel,
            Temperature = settings.Temperature,
            TopP = settings.TopP,
            MaxTokens = settings.MaxTokens,
            EnabledToolGroups = settings.GetEnabledToolGroups(),
            UseHostMode = settings.HostModeEnabled
        };

        try
        {
            await foreach (var chunk in ChatService.SendMessageAsync(_conversation.Id, message, config, _cts.Token))
            {
                switch (chunk.Type)
                {
                    case "Error":
                        _errorMessage = chunk.Content;
                        break;

                    case "ActionPlan":
                        HandleActionPlan(chunk.Content);
                        break;

                    case "ActionStepStart":
                        HandleStepStart(chunk.Content);
                        break;

                    case "ActionStepResult":
                        HandleStepResult(chunk.Content);
                        break;

                    default:
                        if (!chunk.IsComplete)
                        {
                            _streamContent += chunk.Content;
                            _streamType = chunk.Type;
                        }
                        break;
                }

                await InvokeAsync(StateHasChanged);
                if (chunk.IsComplete) break;
            }

            _stats = await ChatService.GetCurrentStatsAsync();
        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }

        _isStreaming = false;
        _currentPlanGoal = null;
        _currentPlanSteps = [];
        _conversation = await ConversationStore.GetAsync(_conversation.Id);
        await InvokeAsync(StateHasChanged);
    }

    private void HandleActionPlan(string json)
    {
        try
        {
            var payload = JsonSerializer.Deserialize<ActionPlanPayload>(json);
            if (payload is null) return;

            _currentPlanGoal = payload.Goal;
            _currentPlanSteps = payload.Steps.Select(s => new ActionPlanDisplay.ActionPlanStep
            {
                StepNumber = s.StepNumber,
                Description = s.Description,
                Status = ActionItemStatus.Pending
            }).ToList();
        }
        catch { /* ignore malformed plan JSON */ }
    }

    private void HandleStepStart(string json)
    {
        try
        {
            var payload = JsonSerializer.Deserialize<ActionStepStartPayload>(json);
            if (payload is null) return;

            var step = _currentPlanSteps.FirstOrDefault(s => s.StepNumber == payload.StepNumber);
            if (step is not null)
            {
                step.Status = ActionItemStatus.Running;
            }

            // Clear streaming content for the new step
            _streamContent = string.Empty;
        }
        catch { /* ignore */ }
    }

    private void HandleStepResult(string json)
    {
        try
        {
            var payload = JsonSerializer.Deserialize<ActionStepResultPayload>(json);
            if (payload is null) return;

            var step = _currentPlanSteps.FirstOrDefault(s => s.StepNumber == payload.StepNumber);
            if (step is not null)
            {
                step.Status = payload.Status;
            }

            // Clear streaming content after step completes
            _streamContent = string.Empty;
        }
        catch { /* ignore */ }
    }

    private async Task OnStopGeneration()
    {
        _cts?.Cancel();
        await ChatService.StopGenerationAsync();
    }

    public void Dispose()
    {
        _cts?.Dispose();
    }
}
