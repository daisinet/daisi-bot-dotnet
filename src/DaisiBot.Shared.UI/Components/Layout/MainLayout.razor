@inherits LayoutComponentBase
@inject IAuthService AuthService
@inject IConversationStore ConversationStore
@inject ChatNavigationState ChatNav
@inject BotNavigationState BotNav
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ILocalInferenceService LocalInference
@inject ISettingsService SettingsService
@implements IDisposable

<MudThemeProvider IsDarkMode="true" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Dense="true">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
                       OnClick="@(_ => _drawerOpen = !_drawerOpen)" />
        <MudText Typo="Typo.h6" Class="ml-3">Daisi Bot</MudText>
        <MudSpacer />
        <HostModeToggle />
        <AuthStatusBadge OnLogoutCompleted="OnLogout" />
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavSidebar @ref="_sidebar"
                    OnConversationSelected="OnConversationSelected"
                    OnNewConversationRequested="OnNewConversation" />

        <MudDivider Class="my-2" />
        <BotListPanel @ref="_botListPanel"
                      OnBotSelected="OnBotSelected"
                      OnNewBotRequested="OnNewBotRequested" />
    </MudDrawer>

    <MudMainContent Class="pa-4">
        @Body
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private NavSidebar? _sidebar;
    private BotListPanel? _botListPanel;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var state = await AuthService.GetAuthStateAsync();
            if (!state.IsAuthenticated)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            await CheckAndDownloadModelsAsync();
        }
    }

    private async Task CheckAndDownloadModelsAsync()
    {
        try
        {
            var settings = await SettingsService.GetSettingsAsync();
            if (!settings.HostModeEnabled) return;

            var missing = await LocalInference.GetRequiredDownloadsAsync();
            if (missing.Count == 0)
            {
                await LocalInference.InitializeAsync();
                return;
            }

            var options = new DialogOptions
            {
                BackdropClick = false,
                CloseOnEscapeKey = false,
                MaxWidth = MaxWidth.Small,
                FullWidth = true
            };
            await DialogService.ShowAsync<ModelDownloadDialog>("Downloading Models", options);
        }
        catch
        {
            // Non-fatal â€” user can still use DaisiNet mode
        }
    }

    private void OnLogout()
    {
        Navigation.NavigateTo("/login");
    }

    private void OnConversationSelected(Guid id)
    {
        ChatNav.SelectConversation(id);
    }

    private async Task OnNewConversation()
    {
        var conversation = new Conversation();
        await ConversationStore.CreateAsync(conversation);
        ChatNav.SelectConversation(conversation.Id);
        if (_sidebar is not null)
            await _sidebar.RefreshAsync();
    }

    private void OnBotSelected(Guid id)
    {
        BotNav.SelectBot(id);
        Navigation.NavigateTo("/bots");
    }

    private async Task OnNewBotRequested()
    {
        var dialog = await DialogService.ShowAsync<BotCreateDialog>("Create Bot");
        var result = await dialog.Result;
        if (result is { Canceled: false, Data: BotInstance bot })
        {
            BotNav.SelectBot(bot.Id);
            Navigation.NavigateTo("/bots");
            if (_botListPanel is not null)
                await _botListPanel.RefreshAsync();
        }
    }

    public void Dispose() { }
}
